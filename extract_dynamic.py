import json
import csv


def parse(data_to_be_processed, csv_file_paths):
	non_taken_feature = ['has_html_report', 'analysis_date', 'last_modification_date','sandbox_name']
	with open(csv_file_paths[0], 'a') as f:
		row = []
		for item in data_to_be_processed:
			if item not in non_taken_feature:
				row.append(item)
		writer = csv.writer(f, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)
		writer.writerow(row)


def extract_dy_file(ranges, static_skipped_files):
	dynamic_skipped_files = {"emotet_behaviour": [], "swrort_behaviour": [], "Nanobot_behaviour": [], "Occamy_behaviour": [],
	                 "Fsysna_behaviour": []}
	json_file_paths = ['dynamic_report/emotet_dynamic/emotet_behaviour',
	                   'dynamic_report/swrort_dynamic/swrort_behaviour',
	                   'dynamic_report/Nanobot_dynamic/Nanobot_behaviour',
	                   'dynamic_report/Occamy_dynamic/Occamy_behaviour',
	                   'dynamic_report/Fsysna_dynamic/Fsysna_behaviour']
	nodes = ["behavior"]
	csv_file_paths = [0] * len(nodes)
	for i in range(len(nodes)):
		csv_file_paths[i] = "./Output/" + nodes[i] + ".csv"
		f = open(csv_file_paths[i], 'w')
		f.close()

	for idx in range(len(ranges)):
		print("Start processing" + json_file_paths[idx] + "....")
		counter = 0
		skip = 0

		skipped_list = []
		if idx == 0:
			skipped_list = static_skipped_files['emotet_static']
		if idx == 1:
			skipped_list = static_skipped_files['swrort_static']
		if idx == 2:
			skipped_list = static_skipped_files['Nanobot_static']
		if idx == 3:
			skipped_list = static_skipped_files['Occamy_static']
		if idx == 4:
			skipped_list = static_skipped_files['Fsysna_static']

		# for each file
		for count in range(ranges[idx]):
			if count in skipped_list:
				continue
			fp = open(json_file_paths[idx] + str(count) + '.json', 'r')
			json_value = fp.read()
			raw_data = json.loads(json_value)
			fp.close()

			virus_ttl_attr = {}
			for attr in raw_data["data"]:
				if 'VirusTotal' in attr["id"]:
					virus_ttl_attr = attr
					break
			# if virusTotal scanned result doesn't exist, continue
			if not virus_ttl_attr:
				skip += 1
				if idx == 0:
					dynamic_skipped_files['emotet_behaviour'].append(count)
				if idx == 1:
					dynamic_skipped_files['swrort_behaviour'].append(count)
				if idx == 2:
					dynamic_skipped_files['Nanobot_behaviour'].append(count)
				if idx == 3:
					dynamic_skipped_files['Occamy_behaviour'].append(count)
				if idx == 4:
					dynamic_skipped_files['Fsysna_behaviour'].append(count)
				# print("Skipped file: " + str(count))
				continue
			counter += 1
			parse(virus_ttl_attr['attributes'], csv_file_paths)
		print("Files used: " + str(counter))
	return dynamic_skipped_files
